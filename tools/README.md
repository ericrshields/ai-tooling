# Claude Code Tools

Utilities for monitoring and optimizing Claude Code usage.

---

## claude-usage-monitor.py

**Purpose**: Analyze Claude Code session files to track tool usage, agent invocations, and token consumption patterns.

### Installation

The script is located at `~/.ai/tools/claude-usage-monitor.py` and is executable.

**Requirements**:
- Python 3.6+
- Standard library only (no external dependencies)

### Usage

```bash
# Analyze last 7 days (default)
~/.ai/tools/claude-usage-monitor.py

# Analyze specific time period
~/.ai/tools/claude-usage-monitor.py --days 30

# Output as JSON for programmatic analysis
~/.ai/tools/claude-usage-monitor.py --days 7 --format json

# Analyze custom session directory
~/.ai/tools/claude-usage-monitor.py --sessions-dir /path/to/sessions
```

### Command-Line Options

| Option | Default | Description |
|--------|---------|-------------|
| `--days N` | 7 | Analyze sessions from last N days |
| `--format FMT` | text | Output format: `text` or `json` |
| `--sessions-dir PATH` | `~/.claude/projects/-home-eshields--ai-context-store/` | Path to session files |

### Output Interpretation

**Agent Usage Section**:
- **Invocations**: Number of times agent was called
- **Avg input tokens**: Average input tokens per invocation
- **Avg output tokens**: Average output generated by agent
- **Avg cache creation**: Average tokens written to prompt cache
- **Avg cache read**: Average tokens read from cache (most dominant metric)
- **Sessions**: Number of unique sessions that used this agent

**Tool Usage Section**:
- **Calls**: Number of times tool was invoked
- **Total tokens**: Sum of all token types for this tool
- **Input**: Tokens consumed by tool input
- **Output**: Tokens generated by tool output
- **Cache create**: Tokens written to cache
- **Cache read**: Tokens read from cache

**Summary Section**:
- Overview statistics across all tools and agents
- Top 5 tools by frequency with percentage breakdown

### Understanding Token Costs

**Token Types** (by cost, highest to lowest):
1. **Input tokens**: Full API cost (~$3/M tokens for Sonnet)
2. **Cache creation**: Same cost as input (~$3/M for Sonnet)
3. **Output tokens**: 3x input cost (~$15/M for Sonnet)
4. **Cache read tokens**: 90% discount (~$0.30/M for Sonnet)

**Optimization Priorities**:
1. **High cache read tokens are GOOD**: Shows effective prompt caching (10x cheaper)
2. **High output tokens**: Review if agents are too verbose
3. **High input tokens**: May indicate inefficient prompting or large file reads
4. **Low cache read ratio**: Missing caching opportunities

### Common Analysis Patterns

**Identify Tool Overuse**:
```bash
~/.ai/tools/claude-usage-monitor.py --days 7 | grep "Bash:"
```
If Bash calls are high, you may be using shell commands instead of dedicated tools (Read, Write, Edit, Grep, Glob).

**Track Agent Efficiency**:
```bash
~/.ai/tools/claude-usage-monitor.py --days 30 --format json | \
  jq '.agent_usage | to_entries[] | {agent: .key, cache_efficiency: (.value.total_cache_read_tokens / (.value.total_input_tokens + .value.total_cache_read_tokens))}'
```
High cache efficiency (>0.9) indicates agent is benefiting from prompt caching.

**Monitor Token Trends**:
Run weekly and compare total token counts. Decreasing totals = improved efficiency.

### Integration with Workflows

**Weekly Review** (recommended):
1. Run monitoring script: `~/.ai/tools/claude-usage-monitor.py --days 7`
2. Review agent invocation patterns (are the right agents triggering?)
3. Check tool usage (are dedicated tools being used over Bash?)
4. Analyze token consumption (cache efficiency, verbose outputs)
5. Update memory files based on findings

**Automation** (optional):
Set up cron job for automated reporting:
```bash
# Run every Monday at 9am
0 9 * * 1 ~/.ai/tools/claude-usage-monitor.py --days 7 > ~/.ai/reports/usage-$(date +\%Y-\%m-\%d).txt
```

### Example Output

```
================================================================================
Claude Code Usage Analysis (Last 7 Days)
================================================================================
Sessions analyzed: 5 (from 28 total files)

AGENT USAGE:
--------------------------------------------------------------------------------
  commit-message-reviewer:
    Invocations: 19
    Avg input tokens: 8
    Avg output tokens: 195
    Avg cache creation: 9,402
    Avg cache read: 127,145
    Sessions: 2

TOOL USAGE:
--------------------------------------------------------------------------------
  Bash:
    Calls: 374
    Total tokens: 2,145,678
    ...

TOP 5 TOOLS (by frequency):
  Bash: 374 calls (34.9%)
  Edit: 211 calls (19.7%)
  Read: 150 calls (14.0%)
  Write: 53 calls (4.9%)
  TaskUpdate: 41 calls (3.8%)
```

### Troubleshooting

**"No sessions found"**: Check that `--sessions-dir` points to correct location. Default is project-specific.

**"Module not found" errors**: Script uses only Python stdlib. Verify Python 3.6+ is installed.

**Timezone warnings**: Script automatically handles timezone-aware timestamps. No action needed.

### Development

**Script Location**: `~/.ai/tools/claude-usage-monitor.py`

**Session File Format**: Claude Code stores sessions as JSONL at `~/.claude/projects/[project]/[session-id].jsonl`

**Data Extraction**: Script parses `tool_use` entries in message content, tracks `Task` tool invocations with `subagent_type` parameter for agent analytics.

---

## Future Tools

Additional monitoring and optimization tools will be documented here as they're developed.
